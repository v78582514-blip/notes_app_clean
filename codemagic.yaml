workflows:
  android_release:
    name: Android Release APK
    max_build_duration: 60
    environment:
      flutter: stable
      xcode: latest

    scripts:
      - name: üîπ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        script: |
          set -euo pipefail
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter clean
          flutter pub get

      - name: üîπ –°–±–æ—Ä–∫–∞ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ APK
        script: |
          set -euo pipefail
          echo "üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–ª–∏–∑..."
          BN=$(date +%s)
          # –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π APK (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ --split-per-abi)
          flutter build apk --release \
            --build-number="$BN" \
            --build-name="1.0.$BN" \
            --no-shrink

      - name: üîπ –ü–æ–∏—Å–∫ –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ APK
        script: |
          set -euo pipefail
          echo "üîç –ò—â–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ APK..."
          ls -R build/app/outputs || true

          mkdir -p build/publish

          # –ò—â–µ–º –ø–æ –≤—Å–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –ø—É—Ç—è–º Flutter/AGP:
          # - build/app/outputs/flutter-apk (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ Flutter)
          # - build/app/outputs/apk        (—Å—Ç–∞—Ä—ã–µ –ø–ª–∞–≥–∏–Ω—ã/—à–∞–±–ª–æ–Ω—ã)
          mapfile -t APKS < <( \
            find build/app/outputs/flutter-apk -type f -name "*release*.apk" -print 2>/dev/null; \
            find build/app/outputs/apk        -type f -name "*release*.apk" -print 2>/dev/null \
          )

          if [ "${#APKS[@]}" -eq 0 ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ release APK –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø—É—Ç—è—Ö."
            exit 1
          fi

          echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã APK:"
          for f in "${APKS[@]}"; do
            echo "   - $f"
          done

          echo "üì¶ –ö–æ–ø–∏—Ä—É–µ–º APK –≤ build/publish ..."
          for f in "${APKS[@]}"; do
            cp -v "$f" build/publish/
          done

          echo "üéâ –ì–æ—Ç–æ–≤–æ. –í build/publish –ª–µ–∂–∞—Ç:"
          ls -l build/publish

    artifacts:
      # –û—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å, –∫—É–¥–∞ –º—ã –≤—Å—ë —Å–ª–æ–∂–∏–ª–∏
      - build/publish/*.apk
      # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –æ—Å—Ç–∞–≤–∏–º –ø—Ä—è–º—ã–µ –ø—É—Ç–∏ (–µ—Å–ª–∏ —à–∞–≥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω)
      - build/app/outputs/flutter-apk/*.apk
      - build/app/outputs/apk/**/*.apk

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "*"
          include: true
          source: true
