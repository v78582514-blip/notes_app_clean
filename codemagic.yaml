workflows:
  android_release:
    name: Android Release APK
    max_build_duration: 60
    environment:
      flutter: stable
      xcode: latest

    scripts:
      - name: üîπ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        script: |
          set -e
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter clean
          flutter pub get

      - name: üîπ –°–±–æ—Ä–∫–∞ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ APK
        script: |
          set -e
          echo "üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º –∏–º–µ–Ω–Ω–æ APK, –∞ –Ω–µ AAB..."
          BN=$(date +%s)
          flutter build apk --release \
            --no-tree-shake-icons \
            --build-number="$BN" \
            --build-name="1.0.$BN" \
            --target-platform android-arm,android-arm64,android-x64
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∏–º, –≥–¥–µ –ø–æ—è–≤–∏–ª—Å—è APK:"
          find build -type f -name "*.apk"

      - name: üîπ –ü–æ–∏—Å–∫ –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ APK
        script: |
          set -e
          echo "üîç –ò—â–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ APK..."
          ls -R build || true

          mkdir -p build/publish

          APK_PATH=$(find build -type f -name "*release*.apk" -print -quit)

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ APK-—Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä–∏–º build/app/outputs:"
            ls -R build/app/outputs || true
            echo "‚ö†Ô∏è –ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–±—Ä–∞—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ Gradle..."
            cd android
            ./gradlew assembleRelease --stacktrace || true
            cd ..
            APK_PATH=$(find build -type f -name "*release*.apk" -print -quit)
          fi

          if [ -z "$APK_PATH" ]; then
            echo "üö® –û—à–∏–±–∫–∞: APK –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫."
            exit 1
          fi

          echo "‚úÖ –ù–∞–π–¥–µ–Ω APK: $APK_PATH"
          cp -v "$APK_PATH" build/publish/

          echo "üéâ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ build/publish"

    artifacts:
      - build/publish/*.apk
      - build/app/outputs/**/*.apk
      - build/**/outputs/**/*.apk

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "*"
          include: true
          source: true
          
