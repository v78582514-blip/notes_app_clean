workflows:
  android_release:
    name: Android Release APK
    max_build_duration: 60
    environment:
      flutter: stable
      xcode: latest

    scripts:
      - name: üîπ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        script: |
          set -euo pipefail
          echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          flutter clean
          flutter pub get

      - name: üîπ –°–±–æ—Ä–∫–∞ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ APK (—á–µ—Ä–µ–∑ Gradle —Å –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π wrapper)
        script: |
          set -euo pipefail
          echo "üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º release —á–µ—Ä–µ–∑ Gradle‚Ä¶"
          BN=$(date +%s)

          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ android/
          cd android

          # 1) –ï—Å–ª–∏ gradlew –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º wrapper
          if [ ! -f "./gradlew" ]; then
            echo "‚ö†Ô∏è gradlew –Ω–µ –Ω–∞–π–¥–µ–Ω. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Gradle Wrapper‚Ä¶"
            # –ü—Ä–æ–≤–µ—Ä–∏–º –Ω–∞–ª–∏—á–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ gradle –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º wrapper –Ω—É–∂–Ω–æ–π –≤–µ—Ä—Å–∏–∏
            if ! command -v gradle >/dev/null 2>&1; then
              echo "‚ùå –í –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –Ω–µ—Ç 'gradle'. –≠—Ç–æ –Ω–µ—Ç–∏–ø–∏—á–Ω–æ –¥–ª—è Codemagic."
              echo "   –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –º–∞—à–∏–Ω—É/–æ–±—Ä–∞–∑ –∏–ª–∏ –¥–æ–±–∞–≤—å preinstall Gradle."
              exit 1
            fi
            gradle --version || true
            gradle wrapper --gradle-version 8.7
            echo "‚úÖ Gradle Wrapper —Å–æ–∑–¥–∞–Ω."

            # –°—Ç—Ä–∞—Ö–æ–≤–∫–∞: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–ø–∏—à–µ–º 8.7 –≤ gradle-wrapper.properties
            WRAPPER_PROP="gradle/wrapper/gradle-wrapper.properties"
            mkdir -p gradle/wrapper
            if [ ! -f "$WRAPPER_PROP" ]; then
              cat > "$WRAPPER_PROP" <<'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.7-all.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
            else
              sed -i.bak 's#distributionUrl=.*#distributionUrl=https\\://services.gradle.org/distributions/gradle-8.7-all.zip#g' "$WRAPPER_PROP" || true
            fi
          fi

          # 2) –î–µ–ª–∞–µ–º gradlew –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
          chmod +x ./gradlew

          # 3) –ü–µ—á–∞—Ç–∞–µ–º –≤–µ—Ä—Å–∏–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
          ./gradlew -v || true

          # 4) –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–ª–∏–∑
          ./gradlew :app:assembleRelease --info --stacktrace

          echo "üìÅ –î–µ—Ä–µ–≤–æ app/build/outputs:"
          ls -R app/build/outputs || true

          # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–µ–Ω—å
          cd ..

      - name: üîπ –ü–æ–∏—Å–∫ –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ APK
        script: |
          set -euo pipefail
          echo "üîç –ò—â–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ APK‚Ä¶"
          mkdir -p build/publish

          FOUND_LIST_FILE="$(mktemp)"
          # –ò—â–µ–º Gradle-–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
          ( find android/app/build/outputs/apk -type f -name "*release*.apk" -print 2>/dev/null || true ) >> "$FOUND_LIST_FILE"
          # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî Flutter-–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
          ( find build/app/outputs            -type f -name "*release*.apk" -print 2>/dev/null || true ) >> "$FOUND_LIST_FILE"
          # –ü—Ä–æ-–∑–∞–ø–∞—Å: –ª—é–±—ã–µ outputs –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö build/
          ( find build -maxdepth 4 -type f -name "*release*.apk" -print 2>/dev/null || true ) >> "$FOUND_LIST_FILE"

          sort -u "$FOUND_LIST_FILE" | sed '/^\s*$/d' > "${FOUND_LIST_FILE}.uniq"

          if [ ! -s "${FOUND_LIST_FILE}.uniq" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ release APK."
            echo "üîé –û—Ç–ª–∞–¥–∫–∞: android/app/build/outputs —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
            ls -R android/app/build/outputs || true
            echo "üîé –û—Ç–ª–∞–¥–∫–∞: build/app/outputs —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
            ls -R build/app/outputs || true
            exit 1
          fi

          echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã APK:"
          cat "${FOUND_LIST_FILE}.uniq"

          echo "üì¶ –ö–æ–ø–∏—Ä—É–µ–º APK –≤ build/publish ‚Ä¶"
          while IFS= read -r apk; do
            cp -v "$apk" build/publish/
          done < "${FOUND_LIST_FILE}.uniq"

          echo "üéâ –ì–æ—Ç–æ–≤–æ. –í build/publish –ª–µ–∂–∞—Ç:"
          ls -l build/publish

    artifacts:
      - build/publish/*.apk
      - android/app/build/outputs/apk/**/*.apk
      - build/app/outputs/**/*.apk
      - build/**/outputs/**/*.apk

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "*"
          include: true
          source: true
          
