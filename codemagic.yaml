workflows:
  android_release:
    name: Android Release APK
    max_build_duration: 60
    environment:
      flutter: stable
      xcode: latest

    scripts:
      - name: ğŸ”¹ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
        script: |
          set -euo pipefail
          echo "ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹..."
          flutter clean
          flutter pub get

      - name: ğŸ”¹ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ñ€ĞµĞ»Ğ¸Ğ·Ğ½Ğ¾Ğ³Ğ¾ APK (Ñ‡ĞµÑ€ĞµĞ· Gradle)
        script: |
          set -euo pipefail
          echo "ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° release Ñ‡ĞµÑ€ĞµĞ· Gradleâ€¦"
          cd android

          if [ ! -f "./gradlew" ]; then
            echo "âš ï¸ gradlew Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Gradle Wrapperâ€¦"
            if ! command -v gradle >/dev/null 2>&1; then
              echo "âŒ Ğ’ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¸ Ğ½ĞµÑ‚ 'gradle'. Ğ­Ñ‚Ğ¾ Ğ½ĞµÑ‚Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ Codemagic."
              exit 1
            fi
            gradle wrapper --gradle-version 8.7
          fi

          chmod +x ./gradlew
          ./gradlew -v || true

          # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°
          ./gradlew :app:assembleRelease --info --stacktrace

          echo "ğŸ“ Ğ”ĞµÑ€ĞµĞ²Ğ¾ outputs:"
          ls -R app/build/outputs || true
          cd ..

      - name: ğŸ”¹ ĞŸĞ¾Ğ¸ÑĞº Ğ¸ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ APK
        script: |
          set -euo pipefail
          echo "ğŸ” Ğ˜Ñ‰ĞµĞ¼ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ APKâ€¦"
          mkdir -p build/publish

          FOUND_LIST_FILE="$(mktemp)"
          ( find android/app/build/outputs/apk -type f -name "*release*.apk" -print 2>/dev/null || true ) >> "$FOUND_LIST_FILE"
          ( find build/app/outputs            -type f -name "*release*.apk" -print 2>/dev/null || true ) >> "$FOUND_LIST_FILE"
          ( find build                        -maxdepth 4 -type f -name "*release*.apk" -print 2>/dev/null || true ) >> "$FOUND_LIST_FILE"

          sort -u "$FOUND_LIST_FILE" | sed '/^\s*$/d' > "${FOUND_LIST_FILE}.uniq"

          if [ ! -s "${FOUND_LIST_FILE}.uniq" ]; then
            echo "âŒ ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ½Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ release APK."
            echo "ğŸ” android/app/build/outputs:"
            ls -R android/app/build/outputs || true
            echo "ğŸ” build/app/outputs:"
            ls -R build/app/outputs || true
            exit 1
          fi

          echo "âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½Ñ‹ APK:"
          cat "${FOUND_LIST_FILE}.uniq"

          echo "ğŸ“¦ ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ APK Ğ² build/publish â€¦"
          while IFS= read -r apk; do
            cp -v "$apk" build/publish/
          done < "${FOUND_LIST_FILE}.uniq"

          echo "ğŸ‰ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾. Ğ’ build/publish Ğ»ĞµĞ¶Ğ°Ñ‚:"
          ls -l build/publish

    artifacts:
      - build/publish/*.apk
      - android/app/build/outputs/apk/**/*.apk
      - build/app/outputs/**/*.apk
      - build/**/outputs/**/*.apk

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "*"
          include: true
          source: true
          
