name: Build & Sign Android APK

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CI: true
      # Ð¤Ð¸ÐºÑ Ð±Ð°Ð³Ð¾Ð² watch'ÐµÑ€Ð° Ð¸ Ð±Ð¾Ð»ÐµÐµ Ñ‚Ð¸Ñ…Ð¸Ð¹ Ð´ÐµÐ¼Ð¾Ð½
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.vfs.watch=false"
      KEY_ALIAS: myKey
      KEY_PASS: myPassword
      STORE_PASS: myPassword
      GRADLE_VERSION: "8.7"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: |
          flutter clean
          flutter pub get

      # ÐÐµ ÑÑ‚Ð°Ð²Ð¸Ð¼ gradle Ñ‡ÐµÑ€ÐµÐ· apt (Ñ‚Ð°Ð¼ 4.x), ÑÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ 8.7 Ð¸ Ð³ÐµÐ½ÐµÑ€Ð¸Ð¼ wrapper
      - name: Ensure Gradle wrapper (download Gradle ${GRADLE_VERSION})
        run: |
          set -euo pipefail
          cd android
          if [ ! -f "./gradlew" ]; then
            echo "No gradlew -> downloading Gradle ${GRADLE_VERSION} to create wrapper..."
            curl -sL "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip" -o gradle.zip
            unzip -q gradle.zip
            ./gradle-${GRADLE_VERSION}/bin/gradle --version
            ./gradle-${GRADLE_VERSION}/bin/gradle wrapper --gradle-version ${GRADLE_VERSION}
          fi
          chmod +x ./gradlew
          ./gradlew --version
          cd ..

      # Ð£Ð¡Ð¢ÐžÐ™Ð§Ð˜Ð’ÐÐ¯ Ð¡Ð‘ÐžÐ ÐšÐ: ÐµÑÐ»Ð¸ Gradle Ð²ÐµÑ€Ð½ÑƒÐ» 1, Ð½Ð¾ APK ÐµÑÑ‚ÑŒ â€” Ð½Ðµ Ð¿Ð°Ð´Ð°Ñ‚ÑŒ
      - name: Build release via Gradle (resilient)
        id: build_gradle
        run: |
          set +e  # ÐÐ• Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÐ¼ÑÑ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐµ â€” ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð·Ð°Ð±Ñ€Ð°Ñ‚ÑŒ APK
          cd android
          echo "ðŸš€ Building APK (disable FS watcher)â€¦"
          ./gradlew :app:assembleRelease \
            --no-watch-fs \
            --info --stacktrace --warning-mode all --console=plain
          BUILD_RC=$?
          echo "ðŸ“ outputs tree:"
          ls -R app/build/outputs || true
          cd ..

          # Ð˜Ñ‰ÐµÐ¼ Ñ€ÐµÐ»Ð¸Ð·Ð½Ñ‹Ðµ APK
          FOUND=$( ( find android/app/build/outputs/apk/release -type f -name "*release*.apk" -print 2>/dev/null || true ) | sort -u )
          echo "FOUND APKs:"
          echo "$FOUND"

          if [ -n "$FOUND" ]; then
            echo "apk_found=true" >> "$GITHUB_OUTPUT"
            echo "âœ… APK Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Gradle Ð²ÐµÑ€Ð½ÑƒÐ» ÐºÐ¾Ð´ $BUILD_RC"
            exit 0
          else
            echo "apk_found=false" >> "$GITHUB_OUTPUT"
            echo "âŒ APK Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. ÐšÐ¾Ð´ Gradle: $BUILD_RC"
            # ÐŸÐµÑ‡Ð°Ñ‚Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÐµÐ·Ð½Ñ‹Ðµ Ð»Ð¾Ð³Ð¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ Ð¿ÐµÑ€Ð²Ð¾Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñƒ
            echo "ðŸ”Ž manifest-merger logs:"
            cat android/app/build/outputs/logs/manifest-merger-release-report.txt 2>/dev/null || true
            echo "ðŸ”Ž Gradle reports:"
            ls -R android/app/build/reports 2>/dev/null || true
            exit $BUILD_RC
          fi

      - name: Locate unsigned/release APK
        id: locate
        run: |
          set -euo pipefail
          FOUND=$( ( find android/app/build/outputs/apk/release -type f -name "*release*.apk" -print 2>/dev/null || true ) | sort -u )
          echo "FOUND:"
          echo "$FOUND"
          UNSIGNED=$(echo "$FOUND" | grep -E 'release.*-unsigned\.apk$' | head -n1 || true)
          RELEASE=$(echo "$FOUND" | grep -E 'release.*\.apk$' | grep -v unsigned | head -n1 || true)

          if [ -n "$UNSIGNED" ]; then
            echo "apk_path=$UNSIGNED" >> "$GITHUB_OUTPUT"
            echo "apk_type=unsigned"  >> "$GITHUB_OUTPUT"
          elif [ -n "$RELEASE" ]; then
            echo "apk_path=$RELEASE"  >> "$GITHUB_OUTPUT"
            echo "apk_type=signed"    >> "$GITHUB_OUTPUT"
          else
            echo "âŒ No release APKs found"
            exit 1
          fi
          echo "Chosen: ${{ steps.locate.outputs.apk_path }}"

      - name: Generate temporary keystore (only if unsigned)
        if: steps.locate.outputs.apk_type == 'unsigned'
        run: |
          set -euo pipefail
          mkdir -p android/app
          keytool -genkeypair \
            -alias "$KEY_ALIAS" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -keystore android/app/tmp-release.jks \
            -storepass "$STORE_PASS" \
            -keypass "$KEY_PASS" \
            -dname "CN=Temp,O=CI,L=Internet,ST=NA,C=US"
          echo "âœ… Keystore created: android/app/tmp-release.jks"

      - name: Sign APK (if unsigned)
        if: steps.locate.outputs.apk_type == 'unsigned'
        run: |
          set -euo pipefail
          APK="${{ steps.locate.outputs.apk_path }}"
          SDK_DIR="${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}"
          BT_DIR=$(ls -d "$SDK_DIR/build-tools/"* | sort -V | tail -1)

          ZIPALIGN="$BT_DIR/zipalign"
          APKSIGNER="$BT_DIR/apksigner"

          echo "Using build-tools: $BT_DIR"
          mkdir -p artifacts

          ALIGNED="artifacts/app-release-aligned.apk"
          "$ZIPALIGN" -v -p 4 "$APK" "$ALIGNED"

          SIGNED="artifacts/app-release-signed.apk"
          "$APKSIGNER" sign \
            --ks android/app/tmp-release.jks \
            --ks-key-alias "$KEY_ALIAS" \
            --ks-pass pass:"$STORE_PASS" \
            --key-pass pass:"$KEY_PASS" \
            --out "$SIGNED" \
            "$ALIGNED"

          "$APKSIGNER" verify --verbose "$SIGNED"
          echo "âœ… Signed APK: $SIGNED"

      - name: Collect APKs
        run: |
          set -e
          mkdir -p artifacts

          if [ "${{ steps.locate.outputs.apk_type }}" = "signed" ]; then
            cp -v "${{ steps.locate.outputs.apk_path }}" artifacts/app-release-signed-by-gradle.apk
          fi

          {
            find android/app/build/outputs/apk/release -type f -name "*release*.apk" -print 2>/dev/null || true
            find android/app/build/outputs/flutter-apk -type f -name "*release*.apk" -print 2>/dev/null || true
          } | sort -u | while read -r f; do
            [ -f "$f" ] && cp -v "$f" "artifacts/$(basename "$f")"
          done

          echo "ðŸ“¦ Final artifacts:"
          ls -l artifacts

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: artifacts/*.apk
          if-no-files-found: error
